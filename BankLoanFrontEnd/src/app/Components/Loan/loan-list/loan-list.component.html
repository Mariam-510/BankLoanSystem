<div class="container py-4">
  <!-- Header Section -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="fw-bold" style="color: #dc3545;">
      <i class="bi bi-file-earmark-text me-2"></i>My Loans
    </h2>
    <button class="btn btn-outline-danger" (click)="loadLoans()" [disabled]="isLoading">
      <i class="bi bi-arrow-repeat" [class.bi-spin]="isLoading"></i>
      <span class="ms-1">{{ isLoading ? 'Refreshing...' : 'Refresh' }}</span>
    </button>
  </div>

  <!-- Enhanced Filter Section -->
  <div class="card mb-4 border-0 shadow-sm" style="border-radius: 10px;">
    <div class="card-body p-4">
      <div class="row g-3 align-items-end">
        <div class="col-md-5">
          <label for="statusFilter" class="form-label fw-semibold small text-muted mb-1">FILTER BY STATUS</label>
          <select id="statusFilter" class="form-select border-2 py-2" [(ngModel)]="statusFilter"
            (change)="applyFilters()" style="border-color: #e0e0e0; border-radius: 8px;">
            <option value="all">All Statuses</option>
            <option value="0">Pending</option>
            <option value="1">Approved</option>
            <option value="2">Rejected</option>
          </select>
        </div>

        <div class="col-md-6">
          <label for="searchQuery" class="form-label fw-semibold small text-muted mb-1">SEARCH LOANS</label>
          <div class="input-group">
            <input type="text" id="searchQuery" class="form-control border-2 py-2" [(ngModel)]="searchQuery"
              (input)="applyFilters()" placeholder="Search by name, type, or ID"
              style="border-color: #e0e0e0; border-radius: 8px;">
          </div>
        </div>

        <div class="col-md-1 d-grid">
          <button class="btn btn-danger py-2" (click)="clearFilters()">
            <i class="bi bi-x-lg"></i> Clear
          </button>
        </div>
      </div>

      <!-- Active Filters -->
      <div *ngIf="hasActiveFilters()" class="mt-3">
        <div class="d-flex flex-wrap gap-2 align-items-center">
          <small class="text-muted me-2">Active filters:</small>
          <span *ngIf="statusFilter !== 'all'" class="badge rounded-pill bg-danger bg-opacity-10 text-danger py-2 px-3">
            Status: {{ getStatusText(+statusFilter) }}
            <button class="btn-close btn-close-danger ms-1" style="font-size: 0.5rem;"
              (click)="removeStatusFilter()"></button>
          </span>
          <span *ngIf="searchQuery" class="badge rounded-pill bg-danger bg-opacity-10 text-danger py-2 px-3">
            Search: "{{ searchQuery }}"
            <button class="btn-close btn-close-danger ms-1" style="font-size: 0.5rem;"
              (click)="searchQuery = ''; applyFilters()"></button>
          </span>
        </div>
      </div>
    </div>
  </div>

  <!-- Error Message -->
  <div *ngIf="errorMessage" class="alert alert-danger shadow-sm" style="border-left: 4px solid #c82333;">
    <i class="bi bi-exclamation-circle me-2"></i> {{ errorMessage }}
  </div>

  <!-- Success Message -->
  <div *ngIf="successMessage" class="alert alert-success border-success shadow-sm">
    <i class="bi bi-check-circle-fill me-2"></i> {{ successMessage }}
  </div>

  <!-- Loading Indicator -->
  <div *ngIf="isLoading" class="text-center py-5">
    <div class="spinner-border text-danger" style="width: 3rem; height: 3rem;" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
    <p class="mt-3 fs-5" style="color: #dc3545;">Loading your loans...</p>
  </div>

  <!-- User View -->
  <div *ngIf="!isLoading">
    <div class="card border-0 shadow-lg" style="border-radius: 10px;">
      <div class="card-header bg-white d-flex justify-content-between align-items-center py-3 border-bottom">
        <h4 class="mb-0 fw-semibold" style="color: #dc3545;">
          <i class="bi bi-list-ul me-2"></i>Loan Applications
          <span class="btn bg-danger ms-1 text-white">{{ filteredLoans.length }}</span>
        </h4>
        <a routerLink="/apply" class="btn btn-danger">
          <i class="bi bi-plus me-1"></i> New Application
        </a>
      </div>

      <div class="card-body p-0">
        <div *ngIf="filteredLoans.length === 0" class="text-center py-5">
          <div class="">
            <i class="bi bi-x-circle-fill fs-1" style="color: #dc3545;"></i>
          </div>
          <h5 class="fw-semibold mb-2" style="color: #dc3545;">No loan applications found</h5>
          <p class="text-muted mb-2">Try adjusting your filters or apply for a new loan</p>
        </div>

        <div *ngIf="filteredLoans.length > 0" class="table-responsive">
          <table class="table table-hover align-middle mb-0">
            <thead class="table-light">
              <tr>
                <th class="px-4 py-3" (click)="toggleSort('createdAt')" style="cursor: pointer;">
                  Date
                  <i *ngIf="sortField === 'createdAt'" class="bi ms-1" [class.bi-arrow-up]="sortDirection === 'asc'"
                    [class.bi-arrow-down]="sortDirection === 'desc'"></i>
                </th>
                <th class="px-4 py-3">ID</th>
                <th class="px-4 py-3">Amount</th>
                <th class="px-4 py-3">Duration</th>
                <th class="px-4 py-3">Type</th>
                <th class="px-4 py-3">Status</th>
                <th class="px-4 py-3">Due Date</th>
                <th class="px-4 py-3">Actions</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let loan of paginatedLoans" class="border-top">
                <td class="px-4 py-3">{{ loan.createdAt | date:'mediumDate' }}</td>
                <td class="px-4 py-3 fw-semibold">{{ loan.id }}</td>
                <td class="px-4 py-3 fw-semibold">{{ loan.amount | currency:'EGP ' }}</td>
                <td class="px-4 py-3">{{ loan.duration }} months</td>
                <td class="px-4 py-3">
                  <span class="badge bg-light text-dark p-5 fw-bold">
                    {{ loan.loanTypeName || 'N/A' }}
                  </span>
                </td>
                <td class="px-4 py-3">
                  <span class="badge p-5" [ngClass]="{
                    'bg-warning text-dark': loan.status === 0,
                    'bg-success': loan.status === 1,
                    'bg-danger': loan.status === 2
                  }">
                    {{ getStatusText(loan.status) }}
                  </span>
                </td>
                <td class="px-4 py-3">
                  <span [ngClass]="{'text-danger': isDueDatePassed(loan)}">
                    {{ calculateDueDate(loan.createdAt, loan.duration) | date:'mediumDate' }}
                    <i *ngIf="isDueDatePassed(loan)" class="bi bi-exclamation-triangle-fill ms-1"
                      data-bs-toggle="tooltip" data-bs-placement="top"
                      [attr.title]="'Payment overdue by ' + getDaysOverdue(loan) + ' days'"></i>
                  </span>
                </td>
                <td class="px-4 py-3">
                  <div class="btn-group btn-group-sm shadow-sm" role="group">
                    <a [routerLink]="['/loans/view', loan.id]" class="btn btn-outline-secondary px-3 position-relative"
                      title="View details" data-bs-toggle="tooltip" data-bs-placement="top">
                      <i class="bi bi-eye-fill"></i>
                    </a>
                    <a *ngIf="loan.status === 0" [routerLink]="['/loans/edit', loan.id]"
                      class="btn btn-outline-secondary px-3 position-relative" title="Edit application"
                      data-bs-toggle="tooltip" data-bs-placement="top">
                      <i class="bi bi-pencil-fill"></i>
                    </a>
                    <button *ngIf="loan.status === 0" class="btn btn-outline-secondary px-3 position-relative"
                      (click)="deleteLoan(loan.id)" title="Delete application" data-bs-toggle="tooltip"
                      data-bs-placement="top">
                      <i class="bi bi-trash-fill"></i>
                    </button>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- Pagination -->
        <div *ngIf="filteredLoans.length > 0" class="card-footer bg-white py-3 border-top">
          <div class="d-flex flex-column align-items-center">
            <nav>
              <ul class="pagination mb-0" style="cursor: pointer !important;">
                <li *ngIf="totalPages > 1" class="page-item" [class.disabled]="currentPage === 1">
                  <a class="page-link text-danger" (click)="currentPage !== 1 && previousPage()"
                    [ngClass]="{'text-danger': currentPage !== 1, 'text-muted': currentPage === 1}"
                    aria-label="Previous">
                    <span aria-hidden="true">&lt;</span>
                  </a>
                </li>
                <ng-container *ngIf="totalPages > 1">
                  <li class="page-item" *ngFor="let page of getVisiblePages()" [class.active]="page === currentPage">
                    <a class="page-link" (click)="goToPage(page)"
                      [ngClass]="{'bg-danger text-white border-danger': page === currentPage, 'text-danger': page !== currentPage}">
                      {{ page }}
                    </a>
                  </li>
                </ng-container>
                <li *ngIf="totalPages > 1" class="page-item" [class.disabled]="currentPage === totalPages">
                  <a class="page-link text-danger" (click)="currentPage !== totalPages && nextPage()"
                    [ngClass]="{'text-danger': currentPage !== totalPages, 'text-muted': currentPage === totalPages}"
                    aria-label="Next">
                    <span aria-hidden="true">&gt;</span>
                  </a>
                </li>
              </ul>
            </nav>
            <div class="mt-2">
              <small class="text-muted">
                Showing {{ (currentPage - 1) * itemsPerPage + 1 }} to
                {{ Math.min(currentPage * itemsPerPage, filteredLoans.length) }} of
                {{ filteredLoans.length }} entries
              </small>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
